<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube ìœ ë£Œê´‘ê³  íŠ¸ë˜ì»¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0a0a1a;
            color: #e1e1e1;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }

        /* Animated gradient background blobs */
        body::before, body::after {
            content: '';
            position: fixed;
            border-radius: 50%;
            filter: blur(120px);
            opacity: 0.4;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }
        body::before {
            width: 600px; height: 600px;
            background: radial-gradient(circle, #6c5ce7, #a855f7);
            top: -200px; left: -100px;
        }
        body::after {
            width: 500px; height: 500px;
            background: radial-gradient(circle, #0ea5e9, #6366f1);
            bottom: -150px; right: -100px;
            animation-delay: -10s;
            animation-direction: reverse;
        }
        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(80px, 40px) scale(1.1); }
            50% { transform: translate(-40px, 80px) scale(0.95); }
            75% { transform: translate(60px, -30px) scale(1.05); }
        }

        /* Glass mixin style */
        .glass {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        header {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(30px);
            -webkit-backdrop-filter: blur(30px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            padding: 24px 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        h1 {
            font-size: 24px;
            font-weight: 700;
            color: #fff;
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        h1 span {
            background: linear-gradient(135deg, #ff6b81, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 13px;
            color: rgba(255,255,255,0.45);
        }

        /* API Key Section */
        .api-section {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .api-section label {
            font-size: 13px;
            font-weight: 600;
            color: rgba(255,255,255,0.5);
            white-space: nowrap;
        }

        .api-section input {
            flex: 1;
            min-width: 200px;
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.06);
            color: #fff;
            font-size: 13px;
            font-family: monospace;
            transition: all 0.3s;
        }

        .api-section input:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.15);
        }

        .btn {
            padding: 8px 18px;
            border-radius: 10px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-save {
            background: rgba(46, 213, 115, 0.2);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.3);
            backdrop-filter: blur(10px);
        }

        .btn-save:hover {
            background: rgba(46, 213, 115, 0.3);
            box-shadow: 0 0 20px rgba(46, 213, 115, 0.2);
        }

        .api-guide {
            font-size: 12px;
            color: rgba(255,255,255,0.3);
        }

        .api-guide a {
            color: #a78bfa;
            text-decoration: none;
        }

        .api-guide a:hover { text-decoration: underline; }

        .api-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .api-status.saved {
            background: rgba(46, 213, 115, 0.15);
            color: #2ed573;
            border: 1px solid rgba(46, 213, 115, 0.2);
        }
        .api-status.empty {
            background: rgba(255, 71, 87, 0.15);
            color: #ff6b81;
            border: 1px solid rgba(255, 71, 87, 0.2);
        }

        /* Search Section */
        .search-section {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(24px);
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
        }

        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.06);
            color: #fff;
            font-size: 16px;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.5);
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.15);
        }

        .btn-search {
            background: linear-gradient(135deg, #ff4757, #a855f7);
            color: #fff;
            padding: 14px 30px;
            font-size: 15px;
            border-radius: 12px;
            border: none;
        }

        .btn-search:hover {
            box-shadow: 0 0 30px rgba(168, 85, 247, 0.3);
            transform: translateY(-1px);
        }
        .btn-search:disabled {
            background: rgba(255,255,255,0.1);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-stop {
            background: rgba(255, 165, 2, 0.2);
            color: #ffa502;
            border: 1px solid rgba(255, 165, 2, 0.3);
            padding: 14px 22px;
            font-size: 15px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .btn-stop:hover {
            background: rgba(255, 165, 2, 0.3);
            box-shadow: 0 0 20px rgba(255, 165, 2, 0.2);
        }

        /* Filters */
        .filters-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            color: rgba(255,255,255,0.4);
        }

        .filter-select {
            padding: 7px 14px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            background: rgba(255,255,255,0.06);
            color: #ccc;
            font-size: 13px;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: rgba(168, 85, 247, 0.4);
            box-shadow: 0 0 15px rgba(168, 85, 247, 0.1);
        }

        /* Progress Bar */
        .progress-bar {
            display: none;
            margin-top: 16px;
        }

        .progress-bar.active { display: block; }

        .progress-track {
            width: 100%;
            height: 6px;
            background: rgba(255,255,255,0.06);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #a855f7, #ff6b81);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
            box-shadow: 0 0 10px rgba(168, 85, 247, 0.4);
        }

        .progress-text {
            font-size: 12px;
            color: rgba(255,255,255,0.4);
            margin-top: 6px;
        }

        /* Results */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .results-count {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
        }

        .results-count strong {
            background: linear-gradient(135deg, #ff6b81, #a855f7);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .search-info {
            font-size: 12px;
            color: rgba(255,255,255,0.3);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #a855f7;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { color: rgba(255,255,255,0.4); font-size: 14px; }

        /* Card Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding-bottom: 20px;
        }

        .video-card {
            background: rgba(255, 255, 255, 0.04);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .video-card:hover {
            border-color: rgba(168, 85, 247, 0.4);
            transform: translateY(-6px);
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.15), 0 0 40px rgba(168, 85, 247, 0.05);
        }

        .thumb-wrapper {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
        }

        .thumb-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .thumb-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.5));
            pointer-events: none;
        }

        .video-card:hover .thumb-wrapper img {
            transform: scale(1.08);
        }

        .views-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1;
        }

        .paid-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, rgba(255,71,87,0.85), rgba(168,85,247,0.85));
            backdrop-filter: blur(10px);
            color: #fff;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1;
            letter-spacing: 0.5px;
        }

        .card-body {
            padding: 16px 18px 18px;
        }

        .video-title {
            font-size: 14px;
            font-weight: 600;
            color: #fff;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .video-stats {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .stat-views, .stat-likes, .stat-comments {
            padding: 4px 10px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .stat-views {
            color: #ff6b81;
            font-weight: 700;
            background: rgba(255, 107, 129, 0.1);
            border: 1px solid rgba(255, 107, 129, 0.15);
        }

        .stat-likes {
            color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
            border: 1px solid rgba(46, 213, 115, 0.15);
        }

        .stat-comments {
            color: #70a1ff;
            background: rgba(112, 161, 255, 0.1);
            border: 1px solid rgba(112, 161, 255, 0.15);
        }

        .stat-views::before { content: 'â–¶ '; font-size: 9px; }
        .stat-likes::before { content: 'â™¥ '; font-size: 9px; }
        .stat-comments::before { content: 'ğŸ’¬ '; font-size: 9px; }

        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-name {
            font-size: 13px;
            color: rgba(255,255,255,0.5);
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .upload-date {
            font-size: 12px;
            color: rgba(255,255,255,0.3);
        }

        /* Load More */
        .load-more-wrapper {
            text-align: center;
            padding: 20px 0 40px;
            display: none;
        }

        .load-more-wrapper.active { display: block; }

        .btn-load-more {
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(20px);
            color: #ccc;
            padding: 14px 40px;
            font-size: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .btn-load-more:hover {
            background: rgba(255,255,255,0.1);
            box-shadow: 0 0 20px rgba(168, 85, 247, 0.1);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: rgba(255,255,255,0.3);
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 15px;
            line-height: 1.6;
        }

        /* Error */
        .error-msg {
            background: rgba(255, 71, 87, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 71, 87, 0.2);
            border-radius: 12px;
            padding: 14px 18px;
            margin-top: 16px;
            color: #ff6b81;
            font-size: 14px;
            display: none;
        }

        .error-msg.active { display: block; }

        /* Quota info */
        .quota-info {
            font-size: 11px;
            color: rgba(255,255,255,0.25);
            text-align: right;
            margin-top: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-row { flex-direction: column; }
            .api-section { flex-direction: column; align-items: stretch; }
            .video-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <h1>YouTube <span>ìœ ë£Œê´‘ê³ </span> íŠ¸ë˜ì»¤</h1>
        <p class="subtitle">ê²½ìŸì‚¬ ë¸Œëœë“œì˜ ìœ ë£Œ í”„ë¡œëª¨ì…˜(êµ¬ì…í•œ í•­ëª©) ì˜ìƒì„ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”</p>

        <div class="api-section">
            <label>API Key</label>
            <input type="password" id="apiKeyInput" placeholder="YouTube Data API v3 í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button class="btn btn-save" id="saveKeyBtn">ì €ì¥</button>
            <span class="api-status" id="apiStatus"></span>
            <div class="api-guide">
                í‚¤ê°€ ì—†ìœ¼ì‹ ê°€ìš”?
                <a href="https://console.cloud.google.com/apis/library/youtube.googleapis.com" target="_blank" rel="noopener">
                    Google Cloud Console
                </a>
                ì—ì„œ ë°œê¸‰ë°›ìœ¼ì„¸ìš”
            </div>
        </div>
    </div>
</header>

<main class="container">
    <div class="search-section">
        <div class="search-row">
            <input type="text" class="search-input" id="brandInput" placeholder="ë¸Œëœë“œëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¼ì„±, Apple, ë‹¤ì´ìŠ¨)">
            <button class="btn btn-search" id="searchBtn">ê²€ìƒ‰</button>
            <button class="btn btn-stop" id="stopBtn" style="display:none;">ì¤‘ì§€</button>
        </div>

        <div class="filters-row">
            <div class="filter-group">
                <label>ì •ë ¬:</label>
                <select class="filter-select" id="sortSelect">
                    <option value="date">ìµœì‹ ìˆœ</option>
                    <option value="viewCount">ì¡°íšŒìˆ˜ìˆœ</option>
                    <option value="likeCount">ì¢‹ì•„ìš”ìˆœ</option>
                    <option value="commentCount">ëŒ“ê¸€ìˆœ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ê¸°ê°„:</label>
                <select class="filter-select" id="dateFilter">
                    <option value="">ì „ì²´</option>
                    <option value="7">ìµœê·¼ 1ì£¼</option>
                    <option value="30" selected>ìµœê·¼ 1ê°œì›”</option>
                    <option value="90">ìµœê·¼ 3ê°œì›”</option>
                    <option value="180">ìµœê·¼ 6ê°œì›”</option>
                    <option value="365">ìµœê·¼ 1ë…„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ìµœëŒ€ ìˆ˜ì§‘:</label>
                <select class="filter-select" id="maxCollect">
                    <option value="100">100ê°œ</option>
                    <option value="200">200ê°œ</option>
                    <option value="500" selected>500ê°œ</option>
                    <option value="1000">1,000ê°œ</option>
                </select>
            </div>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText"></div>
        </div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <div class="results-header" id="resultsHeader" style="display:none;">
        <div>
            <div class="results-count">
                ê²€ìƒ‰ê²°ê³¼ <strong id="resultCount">0</strong>ê±´ <span id="dedupeInfo">(ì¤‘ë³µ ì œê±°ë¨)</span>
            </div>
            <div class="search-info" id="searchInfo"></div>
        </div>
        <div class="quota-info" id="quotaInfo"></div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text" id="loadingText">YouTubeì—ì„œ ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <div class="video-grid" id="videoGrid"></div>

    <div class="load-more-wrapper" id="loadMoreWrapper">
        <button class="btn btn-load-more" id="loadMoreBtn">ë” ë³´ê¸°</button>
    </div>

    <div class="empty-state" id="emptyState">
        <div class="icon">&#128269;</div>
        <p>ë¸Œëœë“œëª…ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ìœ ë£Œê´‘ê³ (êµ¬ì…í•œ í•­ëª©) ì˜ìƒì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
    </div>
</main>

<script>
    // === State ===
    let apiKey = '';
    let allVideos = [];
    let displayedCount = 0;
    const PAGE_SIZE = 48;
    let apiCallCount = 0;
    let totalRawFetched = 0;
    let stopRequested = false;
    let isSearching = false;

    // === DOM References ===
    const $ = id => document.getElementById(id);
    const apiKeyInput = $('apiKeyInput');
    const saveKeyBtn = $('saveKeyBtn');
    const apiStatus = $('apiStatus');
    const brandInput = $('brandInput');
    const searchBtn = $('searchBtn');
    const stopBtn = $('stopBtn');
    const sortSelect = $('sortSelect');
    const dateFilter = $('dateFilter');
    const maxCollect = $('maxCollect');
    const videoGrid = $('videoGrid');
    const loading = $('loading');
    const loadingText = $('loadingText');
    const emptyState = $('emptyState');
    const errorMsg = $('errorMsg');
    const resultsHeader = $('resultsHeader');
    const resultCount = $('resultCount');
    const dedupeInfo = $('dedupeInfo');
    const searchInfo = $('searchInfo');
    const quotaInfo = $('quotaInfo');
    const progressBar = $('progressBar');
    const progressFill = $('progressFill');
    const progressText = $('progressText');
    const loadMoreWrapper = $('loadMoreWrapper');
    const loadMoreBtn = $('loadMoreBtn');

    // === API Key Management ===
    const DEFAULT_API_KEY = 'AIzaSyDYdhJKW-IXi-c2hP6HiKoPURzAAIipYJw';

    function loadApiKey() {
        const saved = localStorage.getItem('yt_api_key');
        if (saved) { apiKey = saved; apiKeyInput.value = saved; updateApiStatus(true); }
        else { apiKey = DEFAULT_API_KEY; apiKeyInput.value = DEFAULT_API_KEY; updateApiStatus(true); }
    }

    function updateApiStatus(saved) {
        apiStatus.textContent = saved ? 'ì €ì¥ë¨' : 'ë¯¸ì„¤ì •';
        apiStatus.className = saved ? 'api-status saved' : 'api-status empty';
    }

    saveKeyBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (!key) return;
        apiKey = key;
        localStorage.setItem('yt_api_key', key);
        updateApiStatus(true);
    });

    // === Helpers ===
    function getPublishedAfter() {
        const days = parseInt(dateFilter.value);
        if (!days) return null;
        const d = new Date();
        d.setDate(d.getDate() - days);
        return d.toISOString();
    }

    // === YouTube Search API â€” paid product placement filter ===
    async function searchPage(query, pageToken) {
        const params = new URLSearchParams({
            part: 'snippet', type: 'video', q: query,
            maxResults: 50, order: 'date', key: apiKey,
            videoPaidProductPlacement: 'true',
            relevanceLanguage: 'ko', regionCode: 'KR'
        });
        const pa = getPublishedAfter();
        if (pa) params.set('publishedAfter', pa);
        if (pageToken) params.set('pageToken', pageToken);

        const resp = await fetch(`https://www.googleapis.com/youtube/v3/search?${params}`);
        apiCallCount++;
        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.error?.message || `API ì˜¤ë¥˜ (${resp.status})`);
        }
        return resp.json();
    }

    // === YouTube Videos API â€” batch stats + description ===
    async function getVideoDetails(videoIds) {
        if (videoIds.length === 0) return {};
        const results = {};
        for (let i = 0; i < videoIds.length; i += 50) {
            if (stopRequested) break;
            const batch = videoIds.slice(i, i + 50);
            const params = new URLSearchParams({
                part: 'statistics,snippet', id: batch.join(','), key: apiKey
            });
            const resp = await fetch(`https://www.googleapis.com/youtube/v3/videos?${params}`);
            apiCallCount++;
            if (!resp.ok) continue;
            const data = await resp.json();
            data.items.forEach(item => {
                results[item.id] = {
                    viewCount: item.statistics.viewCount || '0',
                    likeCount: item.statistics.likeCount || '0',
                    commentCount: item.statistics.commentCount || '0',
                    description: item.snippet.description || ''
                };
            });
        }
        return results;
    }

    // (Sponsor detection removed â€” using YouTube's paid product placement API filter instead)

    // === Format Helpers ===
    function formatDate(isoStr) {
        const d = new Date(isoStr);
        return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
    }

    function formatViews(count) {
        const n = parseInt(count);
        if (isNaN(n)) return 'ì¡°íšŒìˆ˜ ì—†ìŒ';
        if (n >= 100000000) return `${(n/100000000).toFixed(1)}ì–µíšŒ`;
        if (n >= 10000) return `${(n/10000).toFixed(1)}ë§ŒíšŒ`;
        if (n >= 1000) return `${(n/1000).toFixed(1)}ì²œíšŒ`;
        return `${n.toLocaleString()}íšŒ`;
    }

    function decodeHtml(html) { const el = document.createElement('textarea'); el.innerHTML = html; return el.value; }
    function escapeHtml(text) { const el = document.createElement('div'); el.textContent = text; return el.innerHTML; }

    // === Sort ===
    function sortVideos(videos, by) {
        const sorted = [...videos];
        if (by === 'viewCount') sorted.sort((a,b) => (parseInt(b.viewCount)||0) - (parseInt(a.viewCount)||0));
        else if (by === 'likeCount') sorted.sort((a,b) => (parseInt(b.likeCount)||0) - (parseInt(a.likeCount)||0));
        else if (by === 'commentCount') sorted.sort((a,b) => (parseInt(b.commentCount)||0) - (parseInt(a.commentCount)||0));
        else sorted.sort((a,b) => new Date(b.publishedAt) - new Date(a.publishedAt));
        return sorted;
    }

    // === Render ===
    function renderAllFromScratch() {
        videoGrid.innerHTML = '';
        displayedCount = 0;
        showNextPage();
    }

    function showNextPage() {
        const sorted = sortVideos(allVideos, sortSelect.value);
        const toShow = sorted.slice(displayedCount, displayedCount + PAGE_SIZE);
        toShow.forEach(appendCard);
        displayedCount += toShow.length;
        updateResultsUI();
        loadMoreWrapper.classList.toggle('active', displayedCount < allVideos.length);
    }

    function appendCard(v) {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.onclick = () => window.open(`https://www.youtube.com/watch?v=${v.id}`, '_blank');

        const title = escapeHtml(decodeHtml(v.title));
        const channel = escapeHtml(decodeHtml(v.channel));
        const date = formatDate(v.publishedAt);
        const views = formatViews(v.viewCount);
        const likes = formatViews(v.likeCount || '0');
        const comments = formatViews(v.commentCount || '0');

        card.innerHTML = `
            <div class="thumb-wrapper">
                <img src="${v.thumbnail}" alt="" loading="lazy">
                <div class="paid-badge">ìœ ë£Œê´‘ê³ </div>
            </div>
            <div class="card-body">
                <div class="video-title">${title}</div>
                <div class="video-stats">
                    <span class="stat-views">${views}</span>
                    <span class="stat-likes">${likes}</span>
                    <span class="stat-comments">${comments}</span>
                </div>
                <div class="video-meta">
                    <div class="channel-name">${channel}</div>
                    <div class="upload-date">${date}</div>
                </div>
            </div>`;
        videoGrid.appendChild(card);
    }

    function updateResultsUI() {
        resultsHeader.style.display = 'flex';
        resultCount.textContent = allVideos.length;
        dedupeInfo.textContent = totalRawFetched > allVideos.length
            ? `(ì›ë³¸ ${totalRawFetched}ê°œ ì¤‘ ì¤‘ë³µ ${totalRawFetched - allVideos.length}ê°œ ì œê±°)`
            : '';
        quotaInfo.textContent = `API í˜¸ì¶œ: ${apiCallCount}íšŒ`;
    }

    // === Progress ===
    function updateProgress(collected, max, brand, page) {
        progressBar.classList.add('active');
        const pct = Math.min(100, Math.round((collected / max) * 100));
        progressFill.style.width = pct + '%';
        progressText.textContent = `ìˆ˜ì§‘ ì¤‘: ${collected}/${max}ê°œ | "${brand}" í˜ì´ì§€ ${page}`;
    }

    // === Enrich a batch of items with video details ===
    async function enrichItems(items) {
        const ids = items.map(v => v.id);
        const details = await getVideoDetails(ids);
        items.forEach(v => {
            const d = details[v.id];
            if (d) {
                v.viewCount = d.viewCount;
                v.likeCount = d.likeCount;
                v.commentCount = d.commentCount;
                v.description = d.description;
            }
        });
    }

    // === MAIN: Single-query, multi-page deep collection (paid product placement) ===
    async function doSearch() {
        const brand = brandInput.value.trim();
        if (!brand) { showError('ë¸Œëœë“œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (!apiKey) { showError('YouTube Data API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.'); return; }

        hideError();
        allVideos = [];
        displayedCount = 0;
        apiCallCount = 0;
        totalRawFetched = 0;
        stopRequested = false;
        isSearching = true;
        videoGrid.innerHTML = '';
        resultsHeader.style.display = 'none';
        loadMoreWrapper.classList.remove('active');
        emptyState.style.display = 'none';
        loading.classList.add('active');
        searchBtn.style.display = 'none';
        stopBtn.style.display = '';

        const maxTarget = parseInt(maxCollect.value);
        const existingIds = new Set();

        try {
            let pageToken = null;
            let pageNum = 0;

            while (allVideos.length < maxTarget && !stopRequested) {
                pageNum++;
                updateProgress(allVideos.length, maxTarget, brand, pageNum);
                loadingText.textContent = `"${brand}" ìœ ë£Œê´‘ê³  ê²€ìƒ‰ ì¤‘ (í˜ì´ì§€ ${pageNum})...`;

                const data = await searchPage(brand, pageToken);
                pageToken = data.nextPageToken || null;

                const items = (data.items || []);
                if (items.length === 0) break;

                // Filter duplicates
                const newItems = [];
                for (const item of items) {
                    const vid = item.id?.videoId;
                    if (!vid || existingIds.has(vid)) { totalRawFetched++; continue; }
                    existingIds.add(vid);
                    totalRawFetched++;
                    newItems.push({
                        id: vid,
                        title: item.snippet.title,
                        channel: item.snippet.channelTitle,
                        thumbnail: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        publishedAt: item.snippet.publishedAt,
                        viewCount: '0',
                        likeCount: '0',
                        commentCount: '0',
                        description: ''
                    });
                }

                if (newItems.length > 0) {
                    // Enrich with stats + description
                    loadingText.textContent = `ìƒì„¸ì •ë³´ ë¡œë”© ì¤‘ (${newItems.length}ê°œ)...`;
                    await enrichItems(newItems);

                    // Filter: ì¡°íšŒìˆ˜ 1,000íšŒ ì´ìƒë§Œ
                    const filtered = newItems.filter(v => parseInt(v.viewCount) >= 1000);

                    // Add to main list
                    allVideos = allVideos.concat(filtered);

                    // Live render: re-sort & re-render everything
                    renderAllFromScratch();
                    updateProgress(allVideos.length, maxTarget, brand, pageNum);
                }

                // No more pages
                if (!pageToken) break;
            }

            progressBar.classList.remove('active');

            if (allVideos.length === 0) {
                emptyState.innerHTML = `<div class="icon">&#128533;</div><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ ë¸Œëœë“œëª…ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>`;
                emptyState.style.display = 'block';
            } else {
                // Final full re-render with proper sort
                renderAllFromScratch();
                searchInfo.textContent = `"${brand}" ìœ ë£Œê´‘ê³ (êµ¬ì…í•œ í•­ëª©) | ${pageNum}í˜ì´ì§€ ê²€ìƒ‰ ì™„ë£Œ`;
            }

        } catch (err) {
            if (err.message.includes('quota') || err.message.includes('403')) {
                showError(`API í• ë‹¹ëŸ‰ ì´ˆê³¼. í˜„ì¬ê¹Œì§€ ìˆ˜ì§‘ëœ ${allVideos.length}ê°œ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`);
            } else {
                showError(`ê²€ìƒ‰ ì‹¤íŒ¨: ${err.message}`);
            }
        } finally {
            loading.classList.remove('active');
            loadingText.textContent = 'YouTubeì—ì„œ ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            searchBtn.style.display = '';
            stopBtn.style.display = 'none';
            isSearching = false;
            updateResultsUI();
        }
    }

    // === Error Display ===
    function showError(msg) { errorMsg.textContent = msg; errorMsg.classList.add('active'); }
    function hideError() { errorMsg.classList.remove('active'); }

    // === Event Listeners ===
    searchBtn.addEventListener('click', doSearch);
    brandInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
    stopBtn.addEventListener('click', () => { stopRequested = true; });

    sortSelect.addEventListener('change', () => {
        if (allVideos.length > 0) renderAllFromScratch();
    });

    loadMoreBtn.addEventListener('click', showNextPage);

    // === Init ===
    loadApiKey();
</script>

</body>
</html>
