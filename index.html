<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜ˆê´‘ê¸° - YouTube í˜‘ì°¬/ê´‘ê³  íŠ¸ë˜ì»¤</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Black+Han+Sans&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Pretendard', 'Segoe UI', sans-serif;
            background: #f4f5f7;
            color: #191f28;
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            background: #fff;
            border-bottom: 1px solid #e5e8eb;
            padding: 32px 0 24px;
            text-align: center;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 24px;
        }

        h1 {
            font-family: 'Black Han Sans', 'Noto Sans KR', 'Malgun Gothic', sans-serif;
            font-size: 52px;
            font-weight: 900;
            color: #191f28;
            margin-bottom: 8px;
            letter-spacing: -2px;
            text-shadow:
                2px 2px 0px #d1d6db,
                4px 4px 0px #b0b8c1,
                6px 6px 8px rgba(0, 0, 0, 0.12);
        }

        h1 span {
            color: #3182f6;
            text-shadow:
                2px 2px 0px #a3c9ff,
                4px 4px 0px #7ab3ff,
                6px 6px 8px rgba(49, 130, 246, 0.15);
        }

        .subtitle {
            font-size: 14px;
            color: #8b95a1;
            margin-bottom: 4px;
        }

        /* API Key Section */
        .api-section {
            background: #fff;
            border: 1px solid #e5e8eb;
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .api-section label {
            font-size: 13px;
            font-weight: 600;
            color: #6b7684;
            white-space: nowrap;
        }

        .api-section input {
            flex: 1;
            min-width: 200px;
            padding: 8px 14px;
            border-radius: 10px;
            border: 1px solid #e5e8eb;
            background: #f9fafb;
            color: #333d4b;
            font-size: 13px;
            font-family: monospace;
            transition: all 0.2s;
        }

        .api-section input:focus {
            outline: none;
            border-color: #3182f6;
            box-shadow: 0 0 0 3px rgba(49, 130, 246, 0.12);
        }

        .btn {
            padding: 8px 18px;
            border-radius: 10px;
            border: none;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-save {
            background: #e8f3ff;
            color: #3182f6;
        }

        .btn-save:hover {
            background: #d0e8ff;
        }

        .api-guide {
            font-size: 12px;
            color: #8b95a1;
        }

        .api-guide a {
            color: #3182f6;
            text-decoration: none;
        }

        .api-guide a:hover { text-decoration: underline; }

        .api-status {
            font-size: 12px;
            padding: 4px 12px;
            border-radius: 20px;
            font-weight: 600;
        }

        .api-status.saved {
            background: #e8faf0;
            color: #00b86c;
        }
        .api-status.empty {
            background: #fff0f0;
            color: #f04452;
        }

        /* Search Section */
        .search-section {
            background: #fff;
            border: 1px solid #e5e8eb;
            border-radius: 16px;
            padding: 24px;
            margin-top: 20px;
        }

        .search-row {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            border: 1px solid #e5e8eb;
            background: #f9fafb;
            color: #191f28;
            font-size: 16px;
            transition: all 0.2s;
        }

        .search-input::placeholder { color: #b0b8c1; }

        .search-input:focus {
            outline: none;
            border-color: #3182f6;
            box-shadow: 0 0 0 3px rgba(49, 130, 246, 0.12);
            background: #fff;
        }

        .btn-search {
            background: #3182f6;
            color: #fff;
            padding: 14px 30px;
            font-size: 15px;
            border-radius: 12px;
            border: none;
        }

        .btn-search:hover {
            background: #1b64da;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(49, 130, 246, 0.3);
        }
        .btn-search:disabled {
            background: #d1d6db;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .btn-stop {
            background: #fff0ed;
            color: #f04452;
            padding: 14px 22px;
            font-size: 15px;
            border-radius: 12px;
            border: none;
        }

        .btn-stop:hover {
            background: #ffe0db;
        }

        /* Filters */
        .filters-row {
            display: flex;
            gap: 12px;
            margin-top: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .filter-group label {
            font-size: 12px;
            color: #8b95a1;
        }

        .filter-select {
            padding: 7px 14px;
            border-radius: 10px;
            border: 1px solid #e5e8eb;
            background: #f9fafb;
            color: #333d4b;
            font-size: 13px;
            transition: all 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3182f6;
            box-shadow: 0 0 0 3px rgba(49, 130, 246, 0.12);
        }

        /* Progress Bar */
        .progress-bar {
            display: none;
            margin-top: 16px;
        }

        .progress-bar.active { display: block; }

        .progress-track {
            width: 100%;
            height: 6px;
            background: #e5e8eb;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3182f6, #1bc47d);
            border-radius: 3px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            font-size: 12px;
            color: #8b95a1;
            margin-top: 6px;
        }

        /* Results */
        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 24px;
            margin-bottom: 16px;
        }

        .results-count {
            font-size: 14px;
            color: #6b7684;
        }

        .results-count strong {
            color: #3182f6;
        }

        .search-info {
            font-size: 12px;
            color: #8b95a1;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 60px 20px;
        }

        .loading.active { display: block; }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e8eb;
            border-top-color: #3182f6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .loading-text { color: #8b95a1; font-size: 14px; }

        /* Card Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding-bottom: 20px;
        }

        .video-card {
            background: #fff;
            border: 1px solid #e5e8eb;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
            border-color: #d1d6db;
        }

        .thumb-wrapper {
            position: relative;
            aspect-ratio: 16/9;
            overflow: hidden;
            background: #f2f4f6;
        }

        .thumb-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .thumb-wrapper::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(transparent, rgba(0,0,0,0.25));
            pointer-events: none;
        }

        .video-card:hover .thumb-wrapper img {
            transform: scale(1.05);
        }

        .views-badge {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(0,0,0,0.65);
            color: #fff;
            padding: 3px 8px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            z-index: 1;
        }

        .paid-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: #3182f6;
            color: #fff;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            z-index: 1;
            letter-spacing: 0.5px;
        }

        .paid-badge.keyword-badge {
            background: #fe9800;
        }

        .matched-keywords {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .kw-chip {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 11px;
            background: #fff8e1;
            color: #e68a00;
            font-weight: 500;
        }

        .card-body {
            padding: 16px 18px 18px;
        }

        .video-title {
            font-size: 14px;
            font-weight: 600;
            color: #191f28;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .video-stats {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .stat-views, .stat-likes, .stat-comments {
            padding: 4px 10px;
            border-radius: 8px;
        }

        .stat-views {
            color: #f04452;
            font-weight: 700;
            background: #fff0f0;
        }

        .stat-likes {
            color: #00b86c;
            background: #e8faf0;
        }

        .stat-comments {
            color: #3182f6;
            background: #e8f3ff;
        }

        .stat-views::before { content: 'â–¶ '; font-size: 9px; }
        .stat-likes::before { content: 'â™¥ '; font-size: 9px; }
        .stat-comments::before { content: 'ğŸ’¬ '; font-size: 9px; }

        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .channel-name {
            font-size: 13px;
            color: #6b7684;
            max-width: 60%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .upload-date {
            font-size: 12px;
            color: #8b95a1;
        }

        /* Load More */
        .load-more-wrapper {
            text-align: center;
            padding: 20px 0 40px;
            display: none;
        }

        .load-more-wrapper.active { display: block; }

        .btn-load-more {
            background: #fff;
            color: #333d4b;
            padding: 14px 40px;
            font-size: 14px;
            border-radius: 12px;
            border: 1px solid #e5e8eb;
        }

        .btn-load-more:hover {
            background: #f9fafb;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #8b95a1;
        }

        .empty-state .icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state p {
            font-size: 15px;
            line-height: 1.6;
        }

        /* Error */
        .error-msg {
            background: #fff0f0;
            border: 1px solid #ffd4d8;
            border-radius: 12px;
            padding: 14px 18px;
            margin-top: 16px;
            color: #f04452;
            font-size: 14px;
            display: none;
        }

        .error-msg.active { display: block; }

        /* Quota info */
        .quota-info {
            font-size: 11px;
            color: #b0b8c1;
            text-align: right;
            margin-top: 8px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .search-row { flex-direction: column; }
            .api-section { flex-direction: column; align-items: stretch; }
            .video-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<header>
    <div class="container">
        <h1><span>ì˜ˆ</span>ê´‘ê¸°</h1>
        <p class="subtitle">YouTube í˜‘ì°¬ / ìœ ë£Œê´‘ê³  ì˜ìƒ ì¶”ì ê¸°</p>

        <div class="api-section">
            <label>API Key</label>
            <input type="password" id="apiKeyInput" placeholder="YouTube Data API v3 í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <button class="btn btn-save" id="saveKeyBtn">ì €ì¥</button>
            <span class="api-status" id="apiStatus"></span>
            <div class="api-guide">
                í‚¤ê°€ ì—†ìœ¼ì‹ ê°€ìš”?
                <a href="https://console.cloud.google.com/apis/library/youtube.googleapis.com" target="_blank" rel="noopener">
                    Google Cloud Console
                </a>
                ì—ì„œ ë°œê¸‰ë°›ìœ¼ì„¸ìš”
            </div>
        </div>
    </div>
</header>

<main class="container">
    <div class="search-section">
        <div class="search-row">
            <input type="text" class="search-input" id="brandInput" placeholder="ë¸Œëœë“œëª…ì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì‚¼ì„±, Apple, ë‹¤ì´ìŠ¨)">
            <button class="btn btn-search" id="searchBtn">ê²€ìƒ‰</button>
            <button class="btn btn-stop" id="stopBtn" style="display:none;">ì¤‘ì§€</button>
        </div>

        <div class="filters-row">
            <div class="filter-group">
                <label>ì •ë ¬:</label>
                <select class="filter-select" id="sortSelect">
                    <option value="date">ìµœì‹ ìˆœ</option>
                    <option value="viewCount">ì¡°íšŒìˆ˜ìˆœ</option>
                    <option value="likeCount">ì¢‹ì•„ìš”ìˆœ</option>
                    <option value="commentCount">ëŒ“ê¸€ìˆœ</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ê¸°ê°„:</label>
                <select class="filter-select" id="dateFilter">
                    <option value="">ì „ì²´</option>
                    <option value="7">ìµœê·¼ 1ì£¼</option>
                    <option value="30" selected>ìµœê·¼ 1ê°œì›”</option>
                    <option value="90">ìµœê·¼ 3ê°œì›”</option>
                    <option value="180">ìµœê·¼ 6ê°œì›”</option>
                    <option value="365">ìµœê·¼ 1ë…„</option>
                </select>
            </div>
            <div class="filter-group">
                <label>ìµœëŒ€ ìˆ˜ì§‘:</label>
                <select class="filter-select" id="maxCollect">
                    <option value="100">100ê°œ</option>
                    <option value="200">200ê°œ</option>
                    <option value="500" selected>500ê°œ</option>
                    <option value="1000">1,000ê°œ</option>
                </select>
            </div>
        </div>

        <div class="progress-bar" id="progressBar">
            <div class="progress-track">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText"></div>
        </div>
    </div>

    <div class="error-msg" id="errorMsg"></div>

    <div class="results-header" id="resultsHeader" style="display:none;">
        <div>
            <div class="results-count">
                ê²€ìƒ‰ê²°ê³¼ <strong id="resultCount">0</strong>ê±´ <span id="dedupeInfo">(ì¤‘ë³µ ì œê±°ë¨)</span>
            </div>
            <div class="search-info" id="searchInfo"></div>
        </div>
        <div class="quota-info" id="quotaInfo"></div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text" id="loadingText">YouTubeì—ì„œ ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
    </div>

    <div class="video-grid" id="videoGrid"></div>

    <div class="load-more-wrapper" id="loadMoreWrapper">
        <button class="btn btn-load-more" id="loadMoreBtn">ë” ë³´ê¸°</button>
    </div>

    <div class="empty-state" id="emptyState">
        <div class="icon">&#128269;</div>
        <p>ë¸Œëœë“œëª…ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬<br>ìœ ë£Œê´‘ê³ (êµ¬ì…í•œ í•­ëª©) ì˜ìƒì„ ì°¾ì•„ë³´ì„¸ìš”.</p>
    </div>
</main>

<script>
    // === State ===
    let apiKey = '';
    let allVideos = [];
    let displayedCount = 0;
    const PAGE_SIZE = 48;
    let apiCallCount = 0;
    let totalRawFetched = 0;
    let stopRequested = false;
    let isSearching = false;

    // === DOM References ===
    const $ = id => document.getElementById(id);
    const apiKeyInput = $('apiKeyInput');
    const saveKeyBtn = $('saveKeyBtn');
    const apiStatus = $('apiStatus');
    const brandInput = $('brandInput');
    const searchBtn = $('searchBtn');
    const stopBtn = $('stopBtn');
    const sortSelect = $('sortSelect');
    const dateFilter = $('dateFilter');
    const maxCollect = $('maxCollect');
    const videoGrid = $('videoGrid');
    const loading = $('loading');
    const loadingText = $('loadingText');
    const emptyState = $('emptyState');
    const errorMsg = $('errorMsg');
    const resultsHeader = $('resultsHeader');
    const resultCount = $('resultCount');
    const dedupeInfo = $('dedupeInfo');
    const searchInfo = $('searchInfo');
    const quotaInfo = $('quotaInfo');
    const progressBar = $('progressBar');
    const progressFill = $('progressFill');
    const progressText = $('progressText');
    const loadMoreWrapper = $('loadMoreWrapper');
    const loadMoreBtn = $('loadMoreBtn');

    // === API Key Management ===
    const DEFAULT_API_KEY = 'AIzaSyDYdhJKW-IXi-c2hP6HiKoPURzAAIipYJw';

    function loadApiKey() {
        const saved = localStorage.getItem('yt_api_key');
        if (saved) { apiKey = saved; apiKeyInput.value = saved; updateApiStatus(true); }
        else { apiKey = DEFAULT_API_KEY; apiKeyInput.value = DEFAULT_API_KEY; updateApiStatus(true); }
    }

    function updateApiStatus(saved) {
        apiStatus.textContent = saved ? 'ì €ì¥ë¨' : 'ë¯¸ì„¤ì •';
        apiStatus.className = saved ? 'api-status saved' : 'api-status empty';
    }

    saveKeyBtn.addEventListener('click', () => {
        const key = apiKeyInput.value.trim();
        if (!key) return;
        apiKey = key;
        localStorage.setItem('yt_api_key', key);
        updateApiStatus(true);
    });

    // === Helpers ===
    function getPublishedAfter() {
        const days = parseInt(dateFilter.value);
        if (!days) return null;
        const d = new Date();
        d.setDate(d.getDate() - days);
        return d.toISOString();
    }

    // === YouTube Search API ===
    async function searchPage(query, pageToken, usePaidFilter) {
        const params = new URLSearchParams({
            part: 'snippet', type: 'video', q: query,
            maxResults: 50, order: 'date', key: apiKey,
            relevanceLanguage: 'ko', regionCode: 'KR'
        });
        if (usePaidFilter) params.set('videoPaidProductPlacement', 'true');
        const pa = getPublishedAfter();
        if (pa) params.set('publishedAfter', pa);
        if (pageToken) params.set('pageToken', pageToken);

        const resp = await fetch(`https://www.googleapis.com/youtube/v3/search?${params}`);
        apiCallCount++;
        if (!resp.ok) {
            const err = await resp.json();
            throw new Error(err.error?.message || `API ì˜¤ë¥˜ (${resp.status})`);
        }
        return resp.json();
    }

    // === YouTube Videos API â€” batch stats + description ===
    async function getVideoDetails(videoIds) {
        if (videoIds.length === 0) return {};
        const results = {};
        for (let i = 0; i < videoIds.length; i += 50) {
            if (stopRequested) break;
            const batch = videoIds.slice(i, i + 50);
            const params = new URLSearchParams({
                part: 'statistics,snippet', id: batch.join(','), key: apiKey
            });
            const resp = await fetch(`https://www.googleapis.com/youtube/v3/videos?${params}`);
            apiCallCount++;
            if (!resp.ok) continue;
            const data = await resp.json();
            data.items.forEach(item => {
                results[item.id] = {
                    viewCount: item.statistics.viewCount || '0',
                    likeCount: item.statistics.likeCount || '0',
                    commentCount: item.statistics.commentCount || '0',
                    description: item.snippet.description || ''
                };
            });
        }
        return results;
    }

    // === Sponsor keyword detection (title + description) ===
    const SPONSOR_KEYWORDS = ['í˜‘ì°¬', 'ê´‘ê³ ', 'ì œê³µ', 'ìœ ë£Œê´‘ê³ ', 'sponsored', 'ad', '#ad', '#ê´‘ê³ ', '#í˜‘ì°¬', 'ë¸Œëœë””ë“œ', 'ë¸Œëœë“œ ì½˜í…ì¸ ', 'ë‚´ëˆë‚´ì‚° ì•„ë‹˜', 'ì†Œì •ì˜ ì›ê³ ë£Œ'];

    function detectSponsorKeywords(title, description) {
        const text = (title + ' ' + description).toLowerCase();
        return SPONSOR_KEYWORDS.filter(kw => text.includes(kw.toLowerCase()));
    }

    // === Format Helpers ===
    function formatDate(isoStr) {
        const d = new Date(isoStr);
        return `${d.getFullYear()}.${String(d.getMonth()+1).padStart(2,'0')}.${String(d.getDate()).padStart(2,'0')}`;
    }

    function formatViews(count) {
        const n = parseInt(count);
        if (isNaN(n)) return 'ì¡°íšŒìˆ˜ ì—†ìŒ';
        if (n >= 100000000) return `${(n/100000000).toFixed(1)}ì–µíšŒ`;
        if (n >= 10000) return `${(n/10000).toFixed(1)}ë§ŒíšŒ`;
        if (n >= 1000) return `${(n/1000).toFixed(1)}ì²œíšŒ`;
        return `${n.toLocaleString()}íšŒ`;
    }

    function decodeHtml(html) { const el = document.createElement('textarea'); el.innerHTML = html; return el.value; }
    function escapeHtml(text) { const el = document.createElement('div'); el.textContent = text; return el.innerHTML; }

    // === Sort ===
    function sortVideos(videos, by) {
        const sorted = [...videos];
        if (by === 'viewCount') sorted.sort((a,b) => (parseInt(b.viewCount)||0) - (parseInt(a.viewCount)||0));
        else if (by === 'likeCount') sorted.sort((a,b) => (parseInt(b.likeCount)||0) - (parseInt(a.likeCount)||0));
        else if (by === 'commentCount') sorted.sort((a,b) => (parseInt(b.commentCount)||0) - (parseInt(a.commentCount)||0));
        else sorted.sort((a,b) => new Date(b.publishedAt) - new Date(a.publishedAt));
        return sorted;
    }

    // === Render ===
    function renderAllFromScratch() {
        videoGrid.innerHTML = '';
        displayedCount = 0;
        showNextPage();
    }

    function showNextPage() {
        const sorted = sortVideos(allVideos, sortSelect.value);
        const toShow = sorted.slice(displayedCount, displayedCount + PAGE_SIZE);
        toShow.forEach(appendCard);
        displayedCount += toShow.length;
        updateResultsUI();
        loadMoreWrapper.classList.toggle('active', displayedCount < allVideos.length);
    }

    function appendCard(v) {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.onclick = () => window.open(`https://www.youtube.com/watch?v=${v.id}`, '_blank');

        const title = escapeHtml(decodeHtml(v.title));
        const channel = escapeHtml(decodeHtml(v.channel));
        const date = formatDate(v.publishedAt);
        const views = formatViews(v.viewCount);
        const likes = formatViews(v.likeCount || '0');
        const comments = formatViews(v.commentCount || '0');

        const isPaid = v.source === 'ìœ ë£Œê´‘ê³ ';
        const badgeClass = isPaid ? 'paid-badge' : 'paid-badge keyword-badge';
        const badgeText = isPaid ? 'ìœ ë£Œê´‘ê³ ' : 'í˜‘ì°¬ ì¶”ì •';
        const kwHtml = (!isPaid && v.matchedKeywords?.length)
            ? `<div class="matched-keywords">${v.matchedKeywords.map(k => `<span class="kw-chip">${escapeHtml(k)}</span>`).join('')}</div>`
            : '';

        card.innerHTML = `
            <div class="thumb-wrapper">
                <img src="${v.thumbnail}" alt="" loading="lazy">
                <div class="${badgeClass}">${badgeText}</div>
            </div>
            <div class="card-body">
                <div class="video-title">${title}</div>
                ${kwHtml}
                <div class="video-stats">
                    <span class="stat-views">${views}</span>
                    <span class="stat-likes">${likes}</span>
                    <span class="stat-comments">${comments}</span>
                </div>
                <div class="video-meta">
                    <div class="channel-name">${channel}</div>
                    <div class="upload-date">${date}</div>
                </div>
            </div>`;
        videoGrid.appendChild(card);
    }

    function updateResultsUI() {
        resultsHeader.style.display = 'flex';
        resultCount.textContent = allVideos.length;
        dedupeInfo.textContent = totalRawFetched > allVideos.length
            ? `(ì›ë³¸ ${totalRawFetched}ê°œ ì¤‘ ì¤‘ë³µ ${totalRawFetched - allVideos.length}ê°œ ì œê±°)`
            : '';
        quotaInfo.textContent = `API í˜¸ì¶œ: ${apiCallCount}íšŒ`;
    }

    // === Progress ===
    function updateProgress(collected, max, brand, page) {
        progressBar.classList.add('active');
        const pct = Math.min(100, Math.round((collected / max) * 100));
        progressFill.style.width = pct + '%';
        progressText.textContent = `ìˆ˜ì§‘ ì¤‘: ${collected}/${max}ê°œ | "${brand}" í˜ì´ì§€ ${page}`;
    }

    // === Enrich a batch of items with video details ===
    async function enrichItems(items) {
        const ids = items.map(v => v.id);
        const details = await getVideoDetails(ids);
        items.forEach(v => {
            const d = details[v.id];
            if (d) {
                v.viewCount = d.viewCount;
                v.likeCount = d.likeCount;
                v.commentCount = d.commentCount;
                v.description = d.description;
            }
        });
    }

    // === Collect one pass (paid API or keyword) ===
    async function collectPass({ brand, maxTarget, existingIds, usePaidFilter, keywordQueries, sourceLabel, onProgress }) {
        let collected = 0;
        const queries = keywordQueries || [brand];

        for (const query of queries) {
            let pageToken = null;
            let pageNum = 0;

            while (allVideos.length < maxTarget && !stopRequested) {
                pageNum++;
                onProgress(query, pageNum);

                const data = await searchPage(query, pageToken, usePaidFilter);
                pageToken = data.nextPageToken || null;

                const items = (data.items || []);
                if (items.length === 0) break;

                const newItems = [];
                for (const item of items) {
                    const vid = item.id?.videoId;
                    if (!vid || existingIds.has(vid)) { totalRawFetched++; continue; }
                    existingIds.add(vid);
                    totalRawFetched++;
                    newItems.push({
                        id: vid,
                        title: item.snippet.title,
                        channel: item.snippet.channelTitle,
                        thumbnail: item.snippet.thumbnails.high?.url || item.snippet.thumbnails.medium?.url || item.snippet.thumbnails.default?.url,
                        publishedAt: item.snippet.publishedAt,
                        viewCount: '0', likeCount: '0', commentCount: '0',
                        description: '',
                        source: sourceLabel,
                        matchedKeywords: []
                    });
                }

                if (newItems.length > 0) {
                    loadingText.textContent = `ìƒì„¸ì •ë³´ ë¡œë”© ì¤‘ (${newItems.length}ê°œ)...`;
                    await enrichItems(newItems);

                    // í‚¤ì›Œë“œ ëª¨ë“œ: ì œëª©+ì„¤ëª…ì—ì„œ í˜‘ì°¬ í‚¤ì›Œë“œ ë§¤ì¹­ í™•ì¸
                    let filtered;
                    if (!usePaidFilter) {
                        filtered = newItems.filter(v => {
                            const kws = detectSponsorKeywords(decodeHtml(v.title), v.description);
                            if (kws.length > 0) { v.matchedKeywords = kws; return true; }
                            return false;
                        });
                    } else {
                        filtered = newItems;
                    }

                    // ì¡°íšŒìˆ˜ 1,000íšŒ ì´ìƒ
                    filtered = filtered.filter(v => parseInt(v.viewCount) >= 1000);
                    allVideos = allVideos.concat(filtered);
                    collected += filtered.length;
                    renderAllFromScratch();
                    updateProgress(allVideos.length, maxTarget, brand, pageNum);
                }

                if (!pageToken) break;
            }

            if (stopRequested || allVideos.length >= maxTarget) break;
        }
        return collected;
    }

    // === MAIN: Combined search â€” paid placement API + keyword detection ===
    async function doSearch() {
        const brand = brandInput.value.trim();
        if (!brand) { showError('ë¸Œëœë“œëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
        if (!apiKey) { showError('YouTube Data API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•˜ê³  ì €ì¥í•´ì£¼ì„¸ìš”.'); return; }

        hideError();
        allVideos = [];
        displayedCount = 0;
        apiCallCount = 0;
        totalRawFetched = 0;
        stopRequested = false;
        isSearching = true;
        videoGrid.innerHTML = '';
        resultsHeader.style.display = 'none';
        loadMoreWrapper.classList.remove('active');
        emptyState.style.display = 'none';
        loading.classList.add('active');
        searchBtn.style.display = 'none';
        stopBtn.style.display = '';

        const maxTarget = parseInt(maxCollect.value);
        const existingIds = new Set();
        let paidCount = 0, kwCount = 0;

        try {
            // --- Pass 1: ìœ ë£Œê´‘ê³  API (videoPaidProductPlacement) ---
            paidCount = await collectPass({
                brand, maxTarget, existingIds,
                usePaidFilter: true,
                sourceLabel: 'ìœ ë£Œê´‘ê³ ',
                onProgress: (q, pg) => {
                    updateProgress(allVideos.length, maxTarget, brand, pg);
                    loadingText.textContent = `[1/2] "${brand}" ìœ ë£Œê´‘ê³  ê²€ìƒ‰ ì¤‘ (í˜ì´ì§€ ${pg})...`;
                }
            });

            // --- Pass 2: í‚¤ì›Œë“œ ê²€ìƒ‰ (í˜‘ì°¬/ê´‘ê³ /ì œê³µ ë“±) ---
            if (!stopRequested && allVideos.length < maxTarget) {
                const kwQueries = [
                    `${brand} í˜‘ì°¬`,
                    `${brand} ê´‘ê³ `,
                    `${brand} ì œê³µ`,
                    `${brand} sponsored`
                ];
                kwCount = await collectPass({
                    brand, maxTarget, existingIds,
                    usePaidFilter: false,
                    keywordQueries: kwQueries,
                    sourceLabel: 'í‚¤ì›Œë“œ',
                    onProgress: (q, pg) => {
                        updateProgress(allVideos.length, maxTarget, brand, pg);
                        loadingText.textContent = `[2/2] "${q}" í‚¤ì›Œë“œ ê²€ìƒ‰ ì¤‘ (í˜ì´ì§€ ${pg})...`;
                    }
                });
            }

            progressBar.classList.remove('active');

            if (allVideos.length === 0) {
                emptyState.innerHTML = `<div class="icon">&#128533;</div><p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ë‹¤ë¥¸ ë¸Œëœë“œëª…ì„ ì‹œë„í•´ë³´ì„¸ìš”.</p>`;
                emptyState.style.display = 'block';
            } else {
                renderAllFromScratch();
                searchInfo.textContent = `"${brand}" | ìœ ë£Œê´‘ê³  ${paidCount}ê±´ + í‚¤ì›Œë“œ ${kwCount}ê±´`;
            }

        } catch (err) {
            if (err.message.includes('quota') || err.message.includes('403')) {
                showError(`API í• ë‹¹ëŸ‰ ì´ˆê³¼. í˜„ì¬ê¹Œì§€ ìˆ˜ì§‘ëœ ${allVideos.length}ê°œ ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.`);
            } else {
                showError(`ê²€ìƒ‰ ì‹¤íŒ¨: ${err.message}`);
            }
        } finally {
            loading.classList.remove('active');
            loadingText.textContent = 'YouTubeì—ì„œ ì˜ìƒì„ ê²€ìƒ‰í•˜ê³  ìˆìŠµë‹ˆë‹¤...';
            searchBtn.style.display = '';
            stopBtn.style.display = 'none';
            isSearching = false;
            updateResultsUI();
        }
    }

    // === Error Display ===
    function showError(msg) { errorMsg.textContent = msg; errorMsg.classList.add('active'); }
    function hideError() { errorMsg.classList.remove('active'); }

    // === Event Listeners ===
    searchBtn.addEventListener('click', doSearch);
    brandInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
    stopBtn.addEventListener('click', () => { stopRequested = true; });

    sortSelect.addEventListener('change', () => {
        if (allVideos.length > 0) renderAllFromScratch();
    });

    loadMoreBtn.addEventListener('click', showNextPage);

    // === Init ===
    loadApiKey();
</script>

</body>
</html>
